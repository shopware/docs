name: Repository stats (PRs & Issues)

on:
  workflow_dispatch:
    inputs:
      days:
        description: "Number of days to look back"
        required: false
        default: 7
        type: number
      post_to_slack:
        description: "Post report to Slack"
        required: false
        default: false
        type: boolean
  schedule:
    # Weekly on Monday at 09:00 UTC
    - cron: "0 9 * * 1"

jobs:
  gather-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
    steps:
      - name: Gather PR and issue stats
        id: stats
        env:
          GH_REPO: ${{ github.repository }}
          GH_SERVER: ${{ github.server_url }}
          DAYS_RAW: ${{ github.event.inputs.days || 7 }}
        run: |
          # Clamp days to 1â€“365
          DAYS=$DAYS_RAW
          if ! [[ "$DAYS" =~ ^[0-9]+$ ]] || [[ "$DAYS" -lt 1 ]]; then DAYS=7; fi
          if [[ "$DAYS" -gt 365 ]]; then DAYS=365; fi

          START=$(date -u -d "${DAYS} days ago" +%Y-%m-%d)
          END=$(date -u +%Y-%m-%d)

          echo "start_date=$START" >> $GITHUB_OUTPUT
          echo "end_date=$END" >> $GITHUB_OUTPUT

          OWNER="${GH_REPO%%/*}"
          REPO="${GH_REPO#*/}"
          API="https://api.github.com/repos/${OWNER}/${REPO}"

          echo "## Repository activity: $START â†’ $END" > report.md
          echo "" >> report.md

          # Pull requests created (REST: created_at)
          echo "### Pull requests created" >> report.md
          echo "" >> report.md
          curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" \
            "${API}/pulls?state=all&sort=created&direction=desc&per_page=100" | \
            jq -r --arg start "$START" '.[] | select(.created_at[:10] >= $start) | "- [\(.state | ascii_upcase)] #\(.number) \(.title) (created: \(.created_at[:10]))"' > /tmp/pr_created.txt 2>/dev/null || true
          [ -s /tmp/pr_created.txt ] && cat /tmp/pr_created.txt >> report.md || echo "- No PRs in this period" >> report.md
          echo "" >> report.md

          # Pull requests merged (need to fetch closed PRs and filter by merged_at; REST /pulls only returns open+closed, merged_at is on each)
          echo "### Pull requests merged" >> report.md
          echo "" >> report.md
          curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" \
            "${API}/pulls?state=closed&sort=updated&direction=desc&per_page=100" | \
            jq -r --arg start "$START" '.[] | select(.merged_at != null and (.merged_at[:10] >= $start)) | "- #\(.number) \(.title) (merged: \(.merged_at[:10]))"' > /tmp/pr_merged.txt 2>/dev/null || true
          [ -s /tmp/pr_merged.txt ] && cat /tmp/pr_merged.txt >> report.md || echo "- No merged PRs in this period" >> report.md
          echo "" >> report.md

          # Issues opened (REST: created_at)
          echo "### Issues opened" >> report.md
          echo "" >> report.md
          curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" \
            "${API}/issues?state=all&sort=created&direction=desc&per_page=100" | \
            jq -r --arg start "$START" '.[] | select(.pull_request == null and .created_at[:10] >= $start) | "- [\(.state | ascii_upcase)] #\(.number) \(.title) (opened: \(.created_at[:10]))"' > /tmp/issue_opened.txt 2>/dev/null || true
          [ -s /tmp/issue_opened.txt ] && cat /tmp/issue_opened.txt >> report.md || echo "- No issues in this period" >> report.md
          echo "" >> report.md

          # Issues closed (REST: closed_at)
          echo "### Issues closed" >> report.md
          echo "" >> report.md
          curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" \
            "${API}/issues?state=closed&sort=updated&direction=desc&per_page=100" | \
            jq -r --arg start "$START" '.[] | select(.pull_request == null and .closed_at != null and (.closed_at[:10] >= $start)) | "- #\(.number) \(.title) (closed: \(.closed_at[:10]))"' > /tmp/issue_closed.txt 2>/dev/null || true
          [ -s /tmp/issue_closed.txt ] && cat /tmp/issue_closed.txt >> report.md || echo "- No closed issues in this period" >> report.md

          # Slack report
          BASE="$GH_SERVER/$GH_REPO"
          echo "*:chart_with_upwards_trend: Repository stats â€” $START â†’ $END*" > slack_report.txt
          echo "" >> slack_report.txt

          echo "*Pull requests created*" >> slack_report.txt
          curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" \
            "${API}/pulls?state=all&sort=created&direction=desc&per_page=100" | \
            jq -r --arg start "$START" --arg base "$BASE" '.[] | select(.created_at[:10] >= $start) | "â€¢ <\($base)/pull/\(.number)|#\(.number)> \(.title) (_\(.state)_ \(.created_at[:10]))"' > /tmp/slack_pr_created.txt 2>/dev/null || true
          [ -s /tmp/slack_pr_created.txt ] && cat /tmp/slack_pr_created.txt >> slack_report.txt || echo "â€¢ _None_" >> slack_report.txt
          echo "" >> slack_report.txt

          echo "*Pull requests merged*" >> slack_report.txt
          curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" \
            "${API}/pulls?state=closed&sort=updated&direction=desc&per_page=100" | \
            jq -r --arg start "$START" --arg base "$BASE" '.[] | select(.merged_at != null and (.merged_at[:10] >= $start)) | "â€¢ <\($base)/pull/\(.number)|#\(.number)> \(.title) (merged \(.merged_at[:10]))"' > /tmp/slack_pr_merged.txt 2>/dev/null || true
          [ -s /tmp/slack_pr_merged.txt ] && cat /tmp/slack_pr_merged.txt >> slack_report.txt || echo "â€¢ _None_" >> slack_report.txt
          echo "" >> slack_report.txt

          echo "*Issues opened*" >> slack_report.txt
          curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" \
            "${API}/issues?state=all&sort=created&direction=desc&per_page=100" | \
            jq -r --arg start "$START" --arg base "$BASE" '.[] | select(.pull_request == null and .created_at[:10] >= $start) | "â€¢ <\($base)/issues/\(.number)|#\(.number)> \(.title) (_\(.state)_ \(.created_at[:10]))"' > /tmp/slack_issue_opened.txt 2>/dev/null || true
          [ -s /tmp/slack_issue_opened.txt ] && cat /tmp/slack_issue_opened.txt >> slack_report.txt || echo "â€¢ _None_" >> slack_report.txt
          echo "" >> slack_report.txt

          echo "*Issues closed*" >> slack_report.txt
          curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" \
            "${API}/issues?state=closed&sort=updated&direction=desc&per_page=100" | \
            jq -r --arg start "$START" --arg base "$BASE" '.[] | select(.pull_request == null and .closed_at != null and (.closed_at[:10] >= $start)) | "â€¢ <\($base)/issues/\(.number)|#\(.number)> \(.title) (closed \(.closed_at[:10]))"' > /tmp/slack_issue_closed.txt 2>/dev/null || true
          [ -s /tmp/slack_issue_closed.txt ] && cat /tmp/slack_issue_closed.txt >> slack_report.txt || echo "â€¢ _None_" >> slack_report.txt

          echo "" >> slack_report.txt
          echo "<$BASE/actions/runs/${{ github.run_id }}|View workflow run>" >> slack_report.txt

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: repo-stats-report
          path: report.md

      - name: Print report
        run: cat report.md

      - name: Prepare Slack payload
        id: slack_payload
        if: (github.event_name == 'workflow_dispatch' && github.event.inputs.post_to_slack == 'true') || (github.event_name == 'schedule')
        env:
          START_DATE: ${{ steps.stats.outputs.start_date }}
          END_DATE: ${{ steps.stats.outputs.end_date }}
          GH_SERVER: ${{ github.server_url }}
          GH_REPO: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          jq -n --rawfile body slack_report.txt \
            --arg start "$START_DATE" --arg end "$END_DATE" \
            --arg link "$GH_SERVER/$GH_REPO/actions/runs/$GITHUB_RUN_ID" \
            '{
              blocks: [
                { type: "header", text: { type: "plain_text", text: "ðŸ“Š Repository stats", emoji: true } },
                { type: "context", elements: [{ type: "mrkdwn", text: ("ðŸ“… " + $start + " â†’ " + $end + "  |  <" + $link + "|View run>") }] },
                { type: "divider" },
                { type: "section", text: { type: "mrkdwn", text: $body } }
              ]
            }' > payload.json
          echo "payload<<EOF" >> $GITHUB_OUTPUT
          cat payload.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post to Slack
        if: (github.event_name == 'workflow_dispatch' && github.event.inputs.post_to_slack == 'true') || (github.event_name == 'schedule')
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: ${{ steps.slack_payload.outputs.payload }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_NOTIFICATIONS_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
